@model DashboardViewModel

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>@ViewData["Title"] - Ofis Yönetimi</title>

  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css"
        rel="stylesheet" />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        rel="stylesheet" />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        rel="stylesheet" />

</head>

<body>
  <div class="container mt-5">
    <h2 class="text-center mb-4">Ofis, Çalışma Yeri ve Aktif Kontrakt Yönetimi</h2>

    <div class="row mb-4">
      <div class="col-md-6" data-aos="fade-up">
        <div class="card text-white bg-info mb-3">
          <div class="card-header">Toplam Aktif Ofisler</div>
          <div class="card-body">
            <h5 class="card-title">
              <span id="cntOffices">0</span>
            </h5>
          </div>
        </div>
      </div>
      <div class="col-md-6" data-aos="fade-up" data-aos-delay="100">
        <div class="card text-white bg-success mb-3">
          <div class="card-header">Toplam Aktif Çalışma Yerleri</div>
          <div class="card-body">
            <h5 class="card-title">
              <span id="cntWorkplaces">0</span>
            </h5>
          </div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="officeSelect">Ofis Seçin</label>
      <select id="officeSelect" class="form-control">
        <option value="">Ofis Seçin...</option>
      </select>
    </div>

    <div class="form-group">
      <label for="workplaceSelect">Çalışma Yeri Seçin</label>
      <select id="workplaceSelect" class="form-control" disabled>
        <option value="">Önce bir ofis seçin...</option>
      </select>
    </div>

    <div id="employeeNamesContainer"
         class="mb-4 p-2 border rounded"
         style="max-height:200px; overflow-y:auto;">
      <h5>Çalışanlar:</h5>
      <div id="employeeNames"></div>
    </div>

    <input type="hidden" id="selectedEmployeeIds" />
    <input type="hidden" id="selectedContractId" />

    <div class="modal fade" id="mainFormModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ana Form</h5>
            <button type="button" class="close"
                    data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/accident/create'">
              Kaza Ekle
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/accident/list'">
              Kaza Listele
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/medex/create'">
              Muayene Ekle
            </button>
            <button id="medexListBtn"
                    class="btn btn-warning btn-block my-2">
             Muayene Listele
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/employee/create'">
              Kişi Ekle
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/employee/list'">
              Kişi Listele
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/Contract/create'">
              Kontrakt Ekle
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/Contract/list'">
              Kontrakt Listele
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/Office/Create'">
              Ofis Ekle
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/Office/List'">
              Ofis Listele
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/Workplace/Create'">
              Workplace Ekle
            </button>
            <button class="btn btn-warning btn-block my-2"
                    onclick="location.href='/Workplace/List'">
              Workplace Listele
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="form-group mt-4">
      <button id="openMainFormButton"
              class="btn btn-secondary btn-block">
        Ana Formu Aç
      </button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js">
  </script>
  <script
    src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js">
  </script>

  <script
    src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js">
  </script>
  <script
    src="https://cdn.jsdelivr.net/npm/countup.js@2.0.8/dist/countUp.umd.js">
  </script>
  <script
    src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
  </script>
  <script
    src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js">
  </script>

  <script>
  $(function(){
           const token   = Cookies.get('authToken') || '';
          const headers = { 'Authorization': 'Bearer ' + token };
          const $btn    = $('#medexListBtn');

          $btn.prop('disabled', true);

          $.ajax({
                  url: 'https://localhost:44384/api/diag/whoami',
            type: 'GET',
            headers: headers
          })
          .done(function(info){
            const targetUrl = info.claimIsDoctor
              ? '/medex/list'
              : '/medex/litelist';

            $btn.prop('disabled', false)
                .off('click')
                .on('click', () => location.href = targetUrl);
          })
          .fail(function(){
            console.warn('whoami çağrısı başarısız, medex/list default');
            $btn.prop('disabled', false)
                .off('click')
                .on('click', () => location.href = '/medex/list');
          });
    AOS.init({ duration:800, once:true });

    const offVal = @Model.TotalActiveOffices;
    const wpVal  = @Model.TotalActiveCompanies;
            const { CountUp } = countUp;
        const opts = { duration: 2.5 };
        const cOff = new CountUp('cntOffices', offVal, opts);
        const cWp  = new CountUp('cntWorkplaces', wpVal, opts);
    if (!cOff.error) cOff.start();
    if (!cWp.error) cWp.start();

    // 3) confettti
    Swal.fire({
      
      showConfirmButton: false,
      timer: 1,
      willClose: () => {
        confetti({ particleCount: 80, spread: 60, origin:{ y:0.6 } });
      }
    });



    function loadOffices(){
      $.ajax({
        url: 'https://localhost:44384/api/office/all',
        type: 'GET',
        headers: headers,
        success: populateOffices,
        error: ()=> alert('Ofisler yüklenemedi!')
      });
    }
    function populateOffices(list){
      const $sel = $('#officeSelect').empty()
                     .append('<option value="">Ofis Seçin...</option>');
      list.forEach(o => {
        $sel.append(`<option value="${o.id}">${o.officeName}</option>`);
      });
    }

    $('#officeSelect').on('change', function(){
      const officeId = $(this).val();
      $('#workplaceSelect')
        .prop('disabled', !officeId)
        .empty()
        .append('<option value="">Çalışma Yeri Seçin...</option>');
      $('#employeeNames').empty();
      $('#addInspectionButton').prop('disabled', true);

      if (officeId) loadWorkplaces(officeId);
    });

    function loadWorkplaces(officeId){
      $.ajax({
        url: `https://localhost:44384/api/office/${officeId}/active-workplaces`,
        type: 'GET',
        headers: headers,
        success: list => {
          const $sel = $('#workplaceSelect').prop('disabled', false);
          list.forEach(w => {
            $sel.append(`<option value="${w.id}">${w.name}</option>`);
          });
        },
        error: ()=> alert('Çalışma yerleri yüklenemedi!')
      });
    }

    $('#workplaceSelect').on('change', function(){
      const wpId = $(this).val();
      $('#employeeNames').empty();
      $('#addInspectionButton').prop('disabled', true);
      $('#selectedContractId').val('');
      $('#selectedEmployeeIds').val('');

      if (wpId) loadEmployeesByWorkplace(wpId);
    });

    function loadEmployeesByWorkplace(wpId){
      $.ajax({
        url: `https://localhost:44384/api/contracts/byworkplace/${wpId}/employees`,
        type: 'GET',
        headers: headers,
        success: displayEmployeeNames,
        error: (xhr, s, e)=> {
          console.error(e);
          alert('Çalışanlar yüklenemedi!');
        }
      });
    }

    function displayEmployeeNames(contracts){
      let contractId, employeeIds = [];
      contracts.forEach(c => {
        if (c.employees.length){
          contractId = c.id;
          c.employees.forEach(emp => {
            $('#employeeNames').append(`
              <button class="employeeBtn btn btn-outline-primary btn-block my-1"
                      data-employeeid="${emp.id}">
                ${emp.name}
              </button>`);
          });
        }
      });

      $('.employeeBtn').on('click', function(){
        $('.employeeBtn').removeClass('btn-primary')
                         .addClass('btn-outline-primary');
        $(this).removeClass('btn-outline-primary')
               .addClass('btn-primary text-white');

        const empId = $(this).data('employeeid');
        employeeIds = [empId];
        $('#selectedEmployeeIds').val(empId);
        $('#selectedContractId').val(contractId);
        $('#addInspectionButton').prop('disabled', false);
      });


      if ($('#employeeNames').children().length) {
        $('#addInspectionButton').prop('disabled', false);
      }
    }


    $('#addInspectionButton').on('click', function(){
      const emp = encodeURIComponent($('#selectedEmployeeIds').val());
      const con = encodeURIComponent($('#selectedContractId').val());
      window.location.href = `/MuayeneEkle?employeeId=${emp}&contractId=${con}`;
    });


    $('#openMainFormButton').on('click', ()=> $('#mainFormModal').modal('show'));


    loadOffices();
  });
  </script>
</body>
</html>
